<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>University of Ilorin • Billing System (Demo)</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #0b1220;
      --surface: rgba(255, 255, 255, 0.07);
      --surface-2: rgba(255, 255, 255, 0.10);
      --border: rgba(255, 255, 255, 0.14);
      --text: #e5e7eb;
      --muted: rgba(229, 231, 235, 0.74);
      --accent: #60a5fa;
      --accent-2: #a78bfa;
      --warn: #f59e0b;
      --ok: #22c55e;
      --danger: #ef4444;
      --shadow: 0 24px 60px rgba(0,0,0,0.45);
      --radius-xl: 20px;
      --radius-lg: 14px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --ring: 0 0 0 4px rgba(96, 165, 250, 0.30);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      line-height: 1.5;
      color: var(--text);
      background:
        radial-gradient(900px circle at 16% 18%, rgba(96, 165, 250, 0.22), transparent 56%),
        radial-gradient(1100px circle at 82% 74%, rgba(167, 139, 250, 0.18), transparent 60%),
        radial-gradient(700px circle at 58% 14%, rgba(245, 158, 11, 0.14), transparent 56%),
        linear-gradient(180deg, #070b13 0%, var(--bg) 100%);
      padding: clamp(18px, 2.4vw, 34px);
    }

    a { color: inherit; }

    .skip-link {
      position: absolute;
      left: -9999px;
      top: 12px;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--text);
      text-decoration: none;
    }

    .skip-link:focus {
      left: 12px;
      outline: none;
      box-shadow: var(--ring);
    }

    .shell {
      max-width: 1180px;
      margin: 0 auto;
      display: grid;
      gap: 18px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      background: linear-gradient(135deg, rgba(255,255,255,0.09), rgba(255,255,255,0.05));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand h1 {
      margin: 0;
      font-size: clamp(1.05rem, 1.4vw + 0.8rem, 1.35rem);
      letter-spacing: -0.02em;
    }

    .brand p {
      margin: 0;
      color: var(--muted);
      font-size: 0.92rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      white-space: nowrap;
      font-size: 0.9rem;
    }

    main {
      display: grid;
      grid-template-columns: 1.2fr 0.9fr;
      gap: 18px;
      align-items: start;
    }

    @media (max-width: 980px) {
      main { grid-template-columns: 1fr; }
    }

    .card {
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      background: linear-gradient(135deg, rgba(255,255,255,0.09), rgba(255,255,255,0.05));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow: clip;
    }

    .card-header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
    }

    .card-title {
      margin: 0;
      font-size: 1rem;
      letter-spacing: -0.01em;
    }

    .card-body {
      padding: 16px;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 560px) {
      .row { grid-template-columns: 1fr; }
    }

    label {
      display: grid;
      gap: 6px;
      font-size: 0.92rem;
      color: var(--muted);
    }

    input, select, textarea {
      width: 100%;
      padding: 11px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(3, 6, 12, 0.35);
      color: var(--text);
      outline: none;
      transition: border-color 140ms ease, box-shadow 140ms ease, transform 140ms ease;
    }

    textarea { min-height: 90px; resize: vertical; }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(96, 165, 250, 0.55);
      box-shadow: var(--ring);
    }

    input::placeholder, textarea::placeholder {
      color: rgba(229, 231, 235, 0.48);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
    }

    button {
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: -0.01em;
      transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease, background 140ms ease;
    }

    button:hover {
      transform: translateY(-1px);
      border-color: rgba(96, 165, 250, 0.35);
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
    }

    button:active { transform: translateY(0); }

    button:focus-visible {
      outline: none;
      box-shadow: var(--ring);
    }

    .btn-primary {
      border-color: rgba(96, 165, 250, 0.35);
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.95), rgba(167, 139, 250, 0.92));
      color: #08101f;
    }

    .btn-danger {
      border-color: rgba(239, 68, 68, 0.4);
      background: rgba(239, 68, 68, 0.14);
    }

    .btn-ghost {
      background: transparent;
    }

    .hint {
      color: var(--muted);
      font-size: 0.9rem;
      margin: 0;
    }

    .toast {
      display: none;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: var(--muted);
    }

    .toast[data-kind="ok"] { border-color: rgba(34, 197, 94, 0.35); color: rgba(167, 243, 208, 0.95); }
    .toast[data-kind="warn"] { border-color: rgba(245, 158, 11, 0.35); color: rgba(253, 230, 138, 0.95); }
    .toast[data-kind="danger"] { border-color: rgba(239, 68, 68, 0.35); color: rgba(254, 202, 202, 0.95); }

    .statement-grid {
      display: grid;
      gap: 12px;
    }

    .kv {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius-lg);
      background: rgba(0,0,0,0.22);
    }

    .kv strong { color: rgba(229, 231, 235, 0.90); }

    .table {
      width: 100%;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .table th, .table td {
      padding: 10px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 0.95rem;
    }

    .table th {
      color: rgba(229, 231, 235, 0.88);
      background: rgba(255,255,255,0.05);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .table tr:last-child td { border-bottom: none; }
    .money { font-variant-numeric: tabular-nums; white-space: nowrap; }
    .right { text-align: right; }

    .balance {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      padding: 12px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
    }

    .balance h3 {
      margin: 0;
      font-size: 0.95rem;
      color: var(--muted);
      font-weight: 600;
    }

    .balance .value {
      font-size: 1.1rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .value.ok { color: rgba(134, 239, 172, 0.95); }
    .value.warn { color: rgba(253, 230, 138, 0.95); }
    .value.danger { color: rgba(254, 202, 202, 0.95); }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media print {
      body { background: #fff; color: #000; padding: 0; }
      header, .no-print { display: none !important; }
      .card { box-shadow: none; border: 1px solid #ddd; background: #fff; }
      .kv, .balance { background: #fff; border-color: #ddd; }
      .table { border-color: #ddd; }
      .table th { background: #f3f4f6; color: #111827; }
      .table th, .table td { border-bottom-color: #e5e7eb; }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <div class="shell">
    <header>
      <div class="brand">
        <h1>University of Ilorin • Billing System</h1>
        <p>Demo: student profile, charges, payments, statement, export.</p>
      </div>
      <div class="pill" aria-label="Demo status">Offline-first • No backend required</div>
    </header>

    <main id="main" tabindex="-1">
      <section class="card" aria-labelledby="studentTitle">
        <div class="card-header">
          <h2 class="card-title" id="studentTitle">Student profile</h2>
          <div class="pill" id="studentStatus" aria-live="polite">No student loaded</div>
        </div>
        <div class="card-body">
          <form id="studentForm" class="grid" autocomplete="off">
            <div class="row">
              <label>
                Student ID
                <input type="text" id="studentId" required inputmode="text" placeholder="e.g., UIN/24/001" />
              </label>
              <label>
                Full name
                <input type="text" id="studentName" required inputmode="text" placeholder="e.g., Amina Ibrahim" />
              </label>
            </div>

            <div class="row">
              <label>
                Faculty
                <select id="faculty" required>
                  <option value="">Select faculty</option>
                  <option value="Agriculture">Agriculture</option>
                  <option value="Arts">Arts</option>
                  <option value="Engineering">Engineering</option>
                  <option value="Science">Science</option>
                  <option value="Social Sciences">Social Sciences</option>
                </select>
              </label>
              <label>
                Department
                <select id="department" required>
                  <option value="">Select department</option>
                </select>
              </label>
            </div>

            <div class="btn-row no-print">
              <button class="btn-primary" type="submit">Save student</button>
              <button class="btn-ghost" id="resetAll" type="button">Reset demo data</button>
              <span class="hint">Tip: add charges and payments to generate the statement.</span>
            </div>

            <div class="toast" id="toast" role="status" aria-live="polite"></div>
          </form>
        </div>
      </section>

      <section class="card" aria-labelledby="statementTitle">
        <div class="card-header">
          <h2 class="card-title" id="statementTitle">Billing statement</h2>
          <div class="btn-row no-print" aria-label="Statement actions">
            <button type="button" id="exportJson">Export JSON</button>
            <button type="button" id="printStatement">Print</button>
          </div>
        </div>
        <div class="card-body">
          <div class="statement-grid" id="statementSection" hidden>
            <div class="kv" aria-label="Student details">
              <strong>Name</strong><span id="sName">—</span>
              <strong>ID</strong><span id="sId">—</span>
              <strong>Faculty</strong><span id="sFaculty">—</span>
              <strong>Department</strong><span id="sDepartment">—</span>
            </div>

            <div>
              <h3 class="sr-only" id="chargesHeading">Charges</h3>
              <table class="table" aria-describedby="chargesHeading">
                <thead>
                  <tr>
                    <th scope="col">Description</th>
                    <th scope="col" class="right">Amount</th>
                    <th scope="col" class="right no-print">Action</th>
                  </tr>
                </thead>
                <tbody id="chargesTbody">
                  <tr><td colspan="3" class="hint">No charges yet.</td></tr>
                </tbody>
              </table>
            </div>

            <div>
              <h3 class="sr-only" id="paymentsHeading">Payments</h3>
              <table class="table" aria-describedby="paymentsHeading">
                <thead>
                  <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Method</th>
                    <th scope="col" class="right">Amount</th>
                    <th scope="col" class="right no-print">Action</th>
                  </tr>
                </thead>
                <tbody id="paymentsTbody">
                  <tr><td colspan="4" class="hint">No payments yet.</td></tr>
                </tbody>
              </table>
            </div>

            <div class="balance" aria-label="Totals">
              <div>
                <h3>Current balance</h3>
                <p class="hint" id="totalsHint">Charges − payments</p>
              </div>
              <div class="value" id="balanceValue">₦0.00</div>
            </div>
          </div>

          <div id="emptyState" class="hint">
            Add a student to view the statement.
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="actionsTitle">
        <div class="card-header">
          <h2 class="card-title" id="actionsTitle">Billing actions</h2>
          <div class="pill">Quick entry</div>
        </div>
        <div class="card-body">
          <div class="grid" style="gap: 18px;">
            <form id="chargeForm" class="grid" autocomplete="off" aria-label="Add charge">
              <p class="hint" style="margin-top:0;">Add a new charge (tuition, hostel, lab, etc.).</p>
              <div class="row">
                <label>
                  Description
                  <input type="text" id="chargeDesc" required placeholder="e.g., Tuition" />
                </label>
                <label>
                  Amount (NGN)
                  <input type="number" id="chargeAmount" required min="0" step="0.01" inputmode="decimal" placeholder="50000" />
                </label>
              </div>
              <div class="btn-row no-print">
                <button class="btn-primary" type="submit">Add charge</button>
                <button class="btn-ghost" type="reset">Clear</button>
              </div>
            </form>

            <form id="paymentForm" class="grid" autocomplete="off" aria-label="Record payment">
              <p class="hint" style="margin-top:0;">Record a payment against the student’s balance.</p>
              <div class="row">
                <label>
                  Amount (NGN)
                  <input type="number" id="paymentAmount" required min="0" step="0.01" inputmode="decimal" placeholder="20000" />
                </label>
                <label>
                  Method
                  <input type="text" id="paymentMethod" required placeholder="Bank transfer / Cash / Card" />
                </label>
              </div>
              <div class="btn-row no-print">
                <button class="btn-primary" type="submit">Record payment</button>
                <button class="btn-ghost" type="reset">Clear</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <aside class="card" aria-labelledby="assistantTitle">
        <div class="card-header">
          <h2 class="card-title" id="assistantTitle">Assistant (optional)</h2>
          <div class="pill">Local fallback</div>
        </div>
        <div class="card-body">
          <p class="hint" style="margin-top:0;">Ask for fee summaries or what to do next. This demo works offline; you can also plug in an API endpoint.</p>

          <label>
            API endpoint (optional)
            <input type="url" id="assistantEndpoint" placeholder="https://example.com/api/billing-assistant" />
          </label>

          <label>
            Your question
            <textarea id="assistantPrompt" placeholder="Summarize this student's status and recommend next steps."></textarea>
          </label>

          <div class="btn-row no-print">
            <button type="button" class="btn-primary" id="askAssistant">Ask assistant</button>
            <button type="button" class="btn-ghost" id="useLocalAssistant">Use local mode</button>
          </div>

          <div class="toast" id="assistantReply" data-kind="ok" role="status" aria-live="polite" style="display:block; margin-top: 10px;">
            Tip: Save a student first, then add charges and payments.
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // Faculties and departments
    const FACULTIES = {
      "Agriculture": ["Agricultural Economics", "Animal Science", "Crop Protection"],
      "Arts": ["English", "History", "Linguistics"],
      "Engineering": ["Civil Engineering", "Mechanical Engineering", "Electrical Engineering"],
      "Science": ["Biochemistry", "Chemistry", "Physics"],
      "Social Sciences": ["Economics", "Political Science", "Psychology"]
    };

    // Student data
    let student = null;
    let charges = [];
    let payments = [];

    const $ = (id) => document.getElementById(id);

    const STORAGE_KEY = 'unilu.billing.demo.v1';

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (_) {
        return null;
      }
    }

    function saveState() {
      try {
        const payload = {
          savedAt: new Date().toISOString(),
          student,
          charges,
          payments
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (_) {
        // ignore storage errors (private mode/quota)
      }
    }

    function clearState() {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (_) {
        // ignore
      }
    }

    function formatMoney(amount) {
      const n = Number.isFinite(amount) ? amount : 0;
      return n.toLocaleString('en-NG', { style: 'currency', currency: 'NGN' });
    }

    function showToast(kind, message) {
      const toast = $('toast');
      if (!toast) return;
      toast.dataset.kind = kind;
      toast.textContent = message;
      toast.style.display = 'block';
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(() => {
        toast.style.display = 'none';
      }, 3200);
    }

    // Populate departments based on faculty
    $('faculty').addEventListener('change', function() {
      const faculty = this.value;
      const deptSelect = $('department');
      deptSelect.innerHTML = '<option value="">Select Department</option>';
      if (FACULTIES[faculty]) {
        FACULTIES[faculty].forEach(dept => {
          const opt = document.createElement('option');
          opt.value = dept;
          opt.textContent = dept;
          deptSelect.appendChild(opt);
        });
      }
    });

    // Add student
    $('studentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      student = {
        id: $('studentId').value.trim(),
        name: $('studentName').value.trim(),
        faculty: $('faculty').value,
        department: $('department').value
      };
      charges = [];
      payments = [];

      $('studentStatus').textContent = `Loaded: ${student.name}`;
      showToast('ok', 'Student saved. You can now add charges and payments.');
  saveState();
      showStatement();
    });

    // Add charge
    $('chargeForm').addEventListener('submit', function(e) {
      e.preventDefault();
  if (!student) return showToast('warn', 'Add a student first.');
      charges.push({
        description: $('chargeDesc').value.trim(),
        amount: parseFloat($('chargeAmount').value)
      });
      this.reset();
      showToast('ok', 'Charge added.');
  saveState();
      showStatement();
    });

    // Record payment
    $('paymentForm').addEventListener('submit', function(e) {
      e.preventDefault();
  if (!student) return showToast('warn', 'Add a student first.');
      payments.push({
        amount: parseFloat($('paymentAmount').value),
        method: $('paymentMethod').value.trim(),
        date: new Date().toISOString().split('T')[0]
      });
      this.reset();
      showToast('ok', 'Payment recorded.');
  saveState();
      showStatement();
    });

    function computeTotals() {
      const totalCharges = charges.reduce((sum, c) => sum + (Number.isFinite(c.amount) ? c.amount : 0), 0);
      const totalPayments = payments.reduce((sum, p) => sum + (Number.isFinite(p.amount) ? p.amount : 0), 0);
      return { totalCharges, totalPayments, balance: totalCharges - totalPayments };
    }

    function renderCharges() {
      const tbody = $('chargesTbody');
      if (!tbody) return;

      if (!charges.length) {
        tbody.innerHTML = '<tr><td colspan="3" class="hint">No charges yet.</td></tr>';
        return;
      }

      tbody.innerHTML = charges.map((c, idx) => {
        const desc = (c.description || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const amount = formatMoney(c.amount || 0);
        return `
          <tr>
            <td>${desc}</td>
            <td class="right money">${amount}</td>
            <td class="right no-print"><button type="button" class="btn-danger" data-remove-charge="${idx}">Remove</button></td>
          </tr>`;
      }).join('');
    }

    function renderPayments() {
      const tbody = $('paymentsTbody');
      if (!tbody) return;

      if (!payments.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="hint">No payments yet.</td></tr>';
        return;
      }

      tbody.innerHTML = payments.map((p, idx) => {
        const method = (p.method || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const date = (p.date || '—');
        const amount = formatMoney(p.amount || 0);
        return `
          <tr>
            <td>${date}</td>
            <td>${method}</td>
            <td class="right money">${amount}</td>
            <td class="right no-print"><button type="button" class="btn-danger" data-remove-payment="${idx}">Remove</button></td>
          </tr>`;
      }).join('');
    }

    function renderBalance() {
      const { balance } = computeTotals();
      const el = $('balanceValue');
      if (!el) return;
      el.textContent = formatMoney(balance);
      el.classList.remove('ok', 'warn', 'danger');

      if (balance <= 0) el.classList.add('ok');
      else if (balance < 25000) el.classList.add('warn');
      else el.classList.add('danger');
    }

    // Show statement
    function showStatement() {
      if (!student) return;

      $('emptyState').hidden = true;
      const section = $('statementSection');
      section.hidden = false;

      $('sName').textContent = student.name || '—';
      $('sId').textContent = student.id || '—';
      $('sFaculty').textContent = student.faculty || '—';
      $('sDepartment').textContent = student.department || '—';

      renderCharges();
      renderPayments();
      renderBalance();
    }

    document.addEventListener('click', (e) => {
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;

      const chargeIdx = t.getAttribute('data-remove-charge');
      if (chargeIdx !== null) {
        const idx = Number(chargeIdx);
        if (Number.isFinite(idx) && idx >= 0) {
          charges.splice(idx, 1);
          showToast('warn', 'Charge removed.');
          saveState();
          showStatement();
        }
      }

      const paymentIdx = t.getAttribute('data-remove-payment');
      if (paymentIdx !== null) {
        const idx = Number(paymentIdx);
        if (Number.isFinite(idx) && idx >= 0) {
          payments.splice(idx, 1);
          showToast('warn', 'Payment removed.');
          saveState();
          showStatement();
        }
      }
    });

    $('printStatement').addEventListener('click', () => {
      if (!student) return showToast('warn', 'Add a student first.');
      window.print();
    });

    $('exportJson').addEventListener('click', () => {
      if (!student) return showToast('warn', 'Add a student first.');
      const payload = {
        exportedAt: new Date().toISOString(),
        student,
        charges,
        payments,
        totals: computeTotals()
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `billing-statement-${(student.id || 'student').replace(/[^a-z0-9_-]+/gi, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast('ok', 'Exported JSON.');
    });

    $('resetAll').addEventListener('click', () => {
      student = null;
      charges = [];
      payments = [];
  clearState();
      $('studentForm').reset();
      $('chargeForm').reset();
      $('paymentForm').reset();
      $('department').innerHTML = '<option value="">Select department</option>';
      $('studentStatus').textContent = 'No student loaded';
      $('statementSection').hidden = true;
      $('emptyState').hidden = false;
      showToast('warn', 'Demo reset.');
    });

    // Assistant
    let assistantMode = 'local';
    $('useLocalAssistant').addEventListener('click', () => {
      assistantMode = 'local';
      showToast('ok', 'Assistant set to local mode.');
    });

    function localAssistantReply(prompt) {
      const p = (prompt || '').toLowerCase();
      if (!student) return 'Save a student first, then add charges and payments.';
      const { totalCharges, totalPayments, balance } = computeTotals();

      if (p.includes('plan') || p.includes('payment plan') || p.includes('installment') || p.includes('instalment')) {
        if (balance <= 0) return `No outstanding balance. Current balance is ${formatMoney(balance)}.`;
        const months = 3;
        const monthly = balance / months;
        const today = new Date();
        const dates = Array.from({ length: months }, (_, i) => {
          const d = new Date(today);
          d.setMonth(d.getMonth() + i + 1);
          return d.toISOString().split('T')[0];
        });
        return `Suggested 3‑month payment plan for ${formatMoney(balance)}:\n` +
          `1) ${dates[0]} — ${formatMoney(monthly)}\n` +
          `2) ${dates[1]} — ${formatMoney(monthly)}\n` +
          `3) ${dates[2]} — ${formatMoney(monthly)}\n` +
          `Tip: Record each installment as a payment, then print/export the statement.`;
      }

      if (p.includes('next') || p.includes('recommend') || p.includes('what')) {
        if (!charges.length) return 'Next step: add at least one charge (e.g., tuition) to generate the bill.';
        if (balance > 0) return `Balance is ${formatMoney(balance)}. Next step: record a payment and print/export the statement.`;
        return `Balance is ${formatMoney(balance)}. You can print or export the statement.`;
      }

      if (p.includes('summary') || p.includes('summarize') || p.includes('status')) {
        return `${student.name} (${student.id}) has charges of ${formatMoney(totalCharges)} and payments of ${formatMoney(totalPayments)}. Current balance: ${formatMoney(balance)}.`;
      }

      return `Try asking: “Summarize this student's status” or “Recommend next steps”. Balance is ${formatMoney(balance)}.`;
    }

    $('askAssistant').addEventListener('click', async () => {
      const endpoint = $('assistantEndpoint').value.trim();
      const prompt = $('assistantPrompt').value.trim();
      const replyBox = $('assistantReply');

      if (!prompt) {
        replyBox.textContent = 'Type a question first.';
        replyBox.dataset.kind = 'warn';
        return;
      }

      // If an endpoint is present, try it; otherwise local fallback.
      if (endpoint) assistantMode = 'remote';

      if (assistantMode === 'remote' && endpoint) {
        replyBox.textContent = 'Thinking…';
        replyBox.dataset.kind = 'ok';
        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, context: { student, charges, payments, totals: computeTotals() } })
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          const text = (data && (data.reply || data.text || data.message)) || '';
          replyBox.textContent = text || 'No reply returned by endpoint.';
          replyBox.dataset.kind = text ? 'ok' : 'warn';
          return;
        } catch (err) {
          replyBox.textContent = `Endpoint failed (${String(err)}). Using local fallback.`;
          replyBox.dataset.kind = 'warn';
          assistantMode = 'local';
        }
      }

      const local = localAssistantReply(prompt);
      replyBox.textContent = local;
      replyBox.dataset.kind = 'ok';
    });

    // Restore state on load (local mode)
    (function restoreOnLoad() {
      const saved = loadState();
      if (!saved || !saved.student) return;

      student = saved.student;
      charges = Array.isArray(saved.charges) ? saved.charges : [];
      payments = Array.isArray(saved.payments) ? saved.payments : [];

      $('studentId').value = student.id || '';
      $('studentName').value = student.name || '';
      $('faculty').value = student.faculty || '';

      // Populate departments list before selecting
      const deptSelect = $('department');
      deptSelect.innerHTML = '<option value="">Select department</option>';
      if (FACULTIES[student.faculty]) {
        FACULTIES[student.faculty].forEach(dept => {
          const opt = document.createElement('option');
          opt.value = dept;
          opt.textContent = dept;
          deptSelect.appendChild(opt);
        });
      }
      deptSelect.value = student.department || '';

      $('studentStatus').textContent = `Loaded: ${student.name}`;
      $('emptyState').hidden = true;
      showStatement();
      showToast('ok', 'Restored saved demo data.');
    })();
  </script>
</body>
</html>